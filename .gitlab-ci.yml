stages:
  - install
  - build
  - test
  - deploy

install_frontend:
  image: node:20
  stage: install
  script:
    - cd frontend
    - npm ci
  cache:
    key: npm-frontend
    paths:
      - frontend/node_modules/

build_frontend:
  image: node:18
  stage: build
  dependencies:
    - install_frontend
  script:
    - cd frontend
    - npm run build
  artifacts:
    paths:
      - frontend/build/
    expire_in: 1h

test_frontend:
  image: node:20
  stage: test
  dependencies:
    - install_frontend
  script:
    - cd frontend
    - npm run test:ci  # Run the tests in CI mode
  cache:
    key: npm-frontend
    paths:
      - frontend/node_modules/

deploy_frontend:
  image: node:18
  stage: deploy
  script:
    - cd frontend
    - mv build public  # GitLab Pages looks for the public folder

deploy_backend:
  image: node:18
  stage: deploy
  script:
    - cd backend/src
    - ssh user@your-server-ip 'cd /path/to/backend && git pull && npm ci && pm2 restart server'
